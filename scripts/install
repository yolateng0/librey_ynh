#!/bin/bash

#=================================================
# GENERIC START
#=================================================
set -eu

app=$YNH_APP_INSTANCE_NAME
domain=$(ynh_app_setting_get $app domain)

#=================================================
# CREATE USER
#=================================================
ynh_system_user_create --username=$app

#=================================================
# INSTALL FILES
#=================================================
src_path="/var/www/$app"
ynh_setup_source --dest_dir="$src_path"

chown -R $app:$app "$src_path"

#=================================================
# NGINX CONFIGURATION
#=================================================
ynh_add_nginx_config

#=================================================
# PERMISSIONS
#=================================================
ynh_permission_create --permission="main" --url="/"

#=================================================
# SSL CERTIFICATE
#=================================================
yunohost domain cert-install "$domain" || true

#=================================================
# RELOAD SERVICES
#=================================================
systemctl reload nginx

#=================================================
# END
#=================================================
